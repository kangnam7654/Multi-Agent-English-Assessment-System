@startuml
title English Writing Multi-Agent Flow (Simplified)

actor User
participant "UI (FastAPI / Gradio)" as UI
participant "Orchestrator\n(workflow_builder.py)" as Orchestrator
participant "Student Agent" as Student
participant "Assessor Agent" as Assessor
participant "Ollama LLM\n(ChatOllama gpt-oss:20b)" as LLM

User -> UI: RunRequest\nmode, user_prompt,\ngrade_for_student,\ngrade_for_assessor,\nlevel, essay
UI -> Orchestrator: 초기 state 전달

Orchestrator -> Orchestrator: mode/essay 검사
activate Orchestrator
Orchestrator -> Orchestrator: system prompt 생성\n(grade_for_student or grade_for_assessor)
deactivate Orchestrator

alt mode == "synthesis" AND essay 없음
  Orchestrator -> Student: student prompt + user_prompt
  Student -> LLM: 에세이 생성 요청
  LLM --> Student: essay JSON\n(grade, level, essay_english, word_count)
  Student -> Orchestrator: state 업데이트\n(essay 저장, mode=assessment)
end

Orchestrator -> Assessor: assessor prompt + essay
Assessor -> LLM: 평가 요청
LLM --> Assessor: assessment JSON\n(overall_score, per_criterion, feedback)
Assessor -> Orchestrator: assessed_content 저장

Orchestrator --> UI: 최종 AgentState\n(essay, assessed_content, grade, level)
UI --> User: RunResponse 출력

@enduml
